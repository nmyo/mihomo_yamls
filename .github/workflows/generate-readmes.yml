name: Generate Sub-READMEs

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:      # å½“ä¸Šæ¸¸å·¥ä½œæµå®Œæˆåè‡ªåŠ¨è¿è¡Œ
    workflows: ["Update File Test"]
    types:
      - completed

permissions:
  contents: write

jobs:
  generate-readmes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --no-cache-dir pyyaml

      - name: Generate comparison READMEs
        run: |
          python3 - << 'EOF'
          import os
          import urllib.parse
          import yaml

          # ================= é…ç½®åŒº =================
          REPO_URL = "https://github.com/${{ github.repository }}/blob/main"

          DIR_MAP = {
              "Official_Examples": "Mihomo å®˜æ–¹ç¤ºä¾‹ (Official)",
              "General_Config": "é€šç”¨è¿›é˜¶é…ç½® (General Config)",
              "Smart_Mode": "Smart æ¨¡å¼ / è·¯ç”±ä¸“ç”¨ (Smart Mode)",
              "Mobile_Modules": "Android æ‰‹æœºæ¨¡å— (Mobile Modules)"
          }

          IGNORE_DIRS = {".git", ".github"}
          IGNORE_FILES = {"README.md", "LICENSE", "release_body.md"}

          # ================= å·¥å…·å‡½æ•° =================
          def safe_get(data, keys, default="N/A"):
              try:
                  for k in keys:
                      data = data[k]
                  return data
              except Exception:
                  return default

          def file_size(path):
              try:
                  size = os.path.getsize(path)
                  return f"{size} B" if size < 1024 else f"{size / 1024:.1f} KB"
              except Exception:
                  return "Unknown"

          def parse_yaml(path):
              try:
                  with open(path, "r", encoding="utf-8") as f:
                      data = yaml.safe_load(f) or {}
              except Exception:
                  return None

              info = {
                  "mixed_port": safe_get(data, ["mixed-port"], "âŒ"),
                  "mode": safe_get(data, ["mode"], "Rule"),
                  "ipv6": "âœ…" if str(safe_get(data, ["ipv6"], False)).lower() == "true" else "ğŸš«",
                  "allow_lan": "âœ…" if str(safe_get(data, ["allow-lan"], False)).lower() == "true" else "ğŸš«",
                  "tun": "âœ… å¼€å¯" if safe_get(data, ["tun", "enable"], False) else "ğŸš« å…³é—­",
                  "groups": data.get("proxy-groups", []),
                  "rules": data.get("rules", []),
                  "dns": data.get("dns", {}),
              }

              info["group_count"] = len(info["groups"])
              info["rule_count"] = len(info["rules"])

              info["groups_raw"] = []
              for g in info["groups"]:
                  t = g.get("type", "select")
                  icon = "ğŸ‘†"
                  if "url-test" in t or "auto" in t:
                      icon = "â™»ï¸"
                  elif "fallback" in t:
                      icon = "ğŸ”§"
                  elif "load-balance" in t:
                      icon = "âš–ï¸"
                  info["groups_raw"].append(f"| {icon} {g.get('name','Unknown')} | `{t}` |")

              info["dns_raw"] = []
              if info["dns"].get("enable"):
                  for ns in info["dns"].get("nameserver", []):
                      if isinstance(ns, str):
                          proto = "UDP"
                          if ns.startswith("tls://"):
                              proto = "DoT"
                          elif ns.startswith("https://"):
                              proto = "DoH"
                          info["dns_raw"].append(f"| {proto} | `{ns}` |")

              return info

          def comparison_table(configs):
              headers = ["ç‰¹æ€§ / æ–‡ä»¶", "å¤§å°"] + [f"`{k}`" for k in configs]
              lines = [
                  "| " + " | ".join(headers) + " |",
                  "| :--- | :--- " + "| :--- " * len(configs) + "|"
              ]

              lines.append(
                  "| **æ–‡ä»¶å¤§å°** | - | " +
                  " | ".join(v["file_size"] for v in configs.values()) + " |"
              )

              rows = [
                  ("mode", "è¿è¡Œæ¨¡å¼"),
                  ("tun", "TUN"),
                  ("ipv6", "IPv6"),
                  ("allow_lan", "å…è®¸å±€åŸŸç½‘"),
                  ("group_count", "ç­–ç•¥ç»„æ•°é‡"),
                  ("rule_count", "è§„åˆ™æ¡æ•°"),
              ]

              for key, label in rows:
                  row = [f"**{label}**", "-"]
                  for v in configs.values():
                      val = v["parsed"].get(key, "N/A")
                      if key.endswith("_count"):
                          val = f"**{val}**"
                      row.append(str(val))
                  lines.append("| " + " | ".join(row) + " |")

              return "\n".join(lines)

          def generate_readme(root, files):
              rel = os.path.relpath(root, ".")
              title = DIR_MAP.get(os.path.basename(root), os.path.basename(root))

              configs = {}
              for f in sorted(files):
                  if not f.lower().endswith((".yml", ".yaml")) or f in IGNORE_FILES:
                      continue
                  parsed = parse_yaml(os.path.join(root, f))
                  if parsed and (parsed["group_count"] or parsed["rule_count"]):
                      configs[f] = {
                          "file_size": file_size(os.path.join(root, f)),
                          "parsed": parsed
                      }

              out = [
                  f"# ğŸ“‚ {title}",
                  "",
                  f"[ğŸ”™ è¿”å›ä¸»é¡µ](../{'../' * rel.count(os.sep)}README.md)",
                  "",
                  f"> ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ | å…± **{len(configs)}** ä¸ªä¸»è¦é…ç½®",
                  ""
              ]

              if len(configs) > 1:
                  out += ["## âš”ï¸ é…ç½®å¯¹æ¯”", "", comparison_table(configs), ""]

              if configs:
                  out.append("## ğŸ“„ è¯¦ç»†è§£æ")
                  for name, d in configs.items():
                      p = d["parsed"]
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(name)}"
                      out += [
                          f"### ğŸ“ {name}",
                          f"- **å¤§å°**: {d['file_size']}",
                          f"- **æºç **: [æŸ¥çœ‹]({url})",
                          ""
                      ]

                      if p["groups_raw"]:
                          out += [
                              "<details><summary><b>ğŸ” ç­–ç•¥ç»„</b></summary>",
                              "",
                              "| ç­–ç•¥ç»„ | ç±»å‹ |",
                              "| :--- | :--- |",
                              *p["groups_raw"][:15],
                              "</details>",
                              ""
                          ]

                      if p["dns_raw"]:
                          out += [
                              "<details><summary><b>ğŸŒ DNS</b></summary>",
                              "",
                              "| ç±»å‹ | åœ°å€ |",
                              "| :--- | :--- |",
                              *p["dns_raw"],
                              "</details>",
                              ""
                          ]

                      out.append("---")

              out += [
                  "## ğŸ“¦ æ–‡ä»¶åˆ—è¡¨",
                  "",
                  "| æ–‡ä»¶ | å¤§å° | é“¾æ¥ |",
                  "| :--- | :--- | :--- |"
              ]

              for f in sorted(files):
                  if f in IGNORE_FILES or f.startswith("."):
                      continue
                  url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                  out.append(f"| `{f}` | {file_size(os.path.join(root, f))} | [æŸ¥çœ‹]({url}) |")

              return "\n".join(out)

          # ================= ä¸»æµç¨‹ =================
          for root, dirs, files in os.walk("."):
              dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
              if root == ".":
                  continue
              if any(f not in IGNORE_FILES for f in files):
                  with open(os.path.join(root, "README.md"), "w", encoding="utf-8") as f:
                      f.write(generate_readme(root, files))
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add **/README.md
          git commit -m "Docs: auto-generate config comparison READMEs" || echo "No changes"
          git push
